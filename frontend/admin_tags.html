<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSFdle - Administration des Tags</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 30px;
        }
        
        .tab {
            padding: 15px 30px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .character-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .character-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .character-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .character-id {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .tags-section {
            margin-top: 15px;
        }
        
        .current-tags {
            margin-bottom: 10px;
        }
        
        .tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            margin: 2px;
        }
        
        .tag.none {
            background: #6c757d;
        }
        
        .tag-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .save-btn:hover {
            background: #218838;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .export-section {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .export-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        .export-btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè∑Ô∏è MSFdle - Administration des Tags</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('characters')">Personnages</button>
            <button class="tab" onclick="switchTab('stats')">Statistiques</button>
            <button class="tab" onclick="switchTab('export')">Export/Import</button>
        </div>
        
        <!-- Onglet Personnages -->
        <div id="characters-tab" class="tab-content active">
            <div class="search-section">
                <input type="text" id="searchInput" class="search-input" 
                       placeholder="Rechercher un personnage..." 
                       onkeyup="filterCharacters()">
                <div>
                    <label>
                        <input type="checkbox" id="showOnlyWithoutTags" onchange="filterCharacters()">
                        Afficher seulement les personnages sans tags
                    </label>
                </div>
            </div>
            
            <div id="charactersGrid" class="character-grid">
                <!-- Les personnages seront charg√©s ici -->
            </div>
        </div>
        
        <!-- Onglet Statistiques -->
        <div id="stats-tab" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalCharacters">0</div>
                    <div class="stat-label">Total Personnages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="charactersWithTags">0</div>
                    <div class="stat-label">Avec Tags</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="charactersWithoutTags">0</div>
                    <div class="stat-label">Sans Tags</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTags">0</div>
                    <div class="stat-label">Tags Disponibles</div>
                </div>
            </div>
        </div>
        
        <!-- Onglet Export/Import -->
        <div id="export-tab" class="tab-content">
            <div class="export-section">
                <h3>Export des Tags</h3>
                <p>Exporter la configuration actuelle des tags pour sauvegarde:</p>
                <button class="export-btn" onclick="exportTags()">Exporter en Python</button>
                <button class="export-btn" onclick="exportTagsJSON()">Exporter en JSON</button>
                
                <h3 style="margin-top: 30px;">Import de Tags</h3>
                <p>Coller votre configuration de tags ici:</p>
                <textarea id="importData" rows="10" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd;"></textarea>
                <br><br>
                <button class="export-btn" onclick="importTags()">Importer</button>
            </div>
        </div>
    </div>

    <script>
        let allCharacters = [];
        let currentFilter = '';
        let showOnlyWithoutTags = false;

        // Changer d'onglet
        function switchTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Afficher l'onglet s√©lectionn√©
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Charger les donn√©es sp√©cifiques √† l'onglet
            if (tabName === 'stats') {
                loadStats();
            }
        }

        // Charger tous les personnages
        async function loadCharacters() {
            try {
                const response = await fetch('/api/characters');
                const data = await response.json();
                
                if (data.success) {
                    allCharacters = data.characters;
                    displayCharacters(allCharacters);
                } else {
                    console.error('Erreur lors du chargement:', data.error);
                }
            } catch (error) {
                console.error('Erreur r√©seau:', error);
            }
        }

        // Afficher les personnages
        function displayCharacters(characters) {
            const grid = document.getElementById('charactersGrid');
            grid.innerHTML = '';
            
            characters.forEach(character => {
                const card = document.createElement('div');
                card.className = 'character-card';
                
                const tagsHtml = character.tags === 'AUCUN' ? 
                    '<span class="tag none">AUCUN</span>' :
                    character.tags.split(', ').map(tag => 
                        `<span class="tag">${tag}</span>`
                    ).join('');
                
                card.innerHTML = `
                    <div class="character-name">${character.alias}</div>
                    <div class="character-id">${character.character_id}</div>
                    <div class="current-tags">
                        Tags actuels: ${tagsHtml}
                    </div>
                    <div class="tags-section">
                        <input type="text" class="tag-input" id="tags-${character.id}" 
                               placeholder="Entrez les tags s√©par√©s par des virgules"
                               value="${character.tags === 'AUCUN' ? '' : character.tags}">
                        <button class="save-btn" onclick="saveTags(${character.id}, '${character.character_id}')">
                            Sauvegarder
                        </button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Filtrer les personnages
        function filterCharacters() {
            currentFilter = document.getElementById('searchInput').value.toLowerCase();
            showOnlyWithoutTags = document.getElementById('showOnlyWithoutTags').checked;
            
            let filtered = allCharacters.filter(character => {
                const matchesSearch = character.alias.toLowerCase().includes(currentFilter) ||
                                    character.character_id.toLowerCase().includes(currentFilter);
                const matchesTagFilter = !showOnlyWithoutTags || character.tags === 'AUCUN';
                
                return matchesSearch && matchesTagFilter;
            });
            
            displayCharacters(filtered);
        }

        // Sauvegarder les tags d'un personnage
        async function saveTags(characterId, characterIdStr) {
            const input = document.getElementById(`tags-${characterId}`);
            const tags = input.value.trim();
            
            try {
                // Pour l'instant, on met √† jour localement
                // TODO: Impl√©menter l'API pour sauvegarder les tags
                console.log(`Sauvegarder tags pour ${characterIdStr}: ${tags}`);
                
                // Mettre √† jour localement
                const character = allCharacters.find(c => c.id === characterId);
                if (character) {
                    character.tags = tags || 'AUCUN';
                    filterCharacters(); // Rafra√Æchir l'affichage
                }
                
                alert('Tags sauvegard√©s! (simulation)');
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                alert('Erreur lors de la sauvegarde');
            }
        }

        // Charger les statistiques
        function loadStats() {
            const total = allCharacters.length;
            const withTags = allCharacters.filter(c => c.tags !== 'AUCUN').length;
            const withoutTags = total - withTags;
            
            document.getElementById('totalCharacters').textContent = total;
            document.getElementById('charactersWithTags').textContent = withTags;
            document.getElementById('charactersWithoutTags').textContent = withoutTags;
            
            // Compter les tags uniques
            const uniqueTags = new Set();
            allCharacters.forEach(character => {
                if (character.tags !== 'AUCUN') {
                    character.tags.split(', ').forEach(tag => {
                        uniqueTags.add(tag.trim());
                    });
                }
            });
            
            document.getElementById('totalTags').textContent = uniqueTags.size;
        }

        // Exporter en Python
        function exportTags() {
            const tagsByCharacter = {};
            const allTagsSet = new Set();
            
            allCharacters.forEach(character => {
                if (character.tags !== 'AUCUN') {
                    const tags = character.tags.split(', ').map(tag => tag.trim());
                    tagsByCharacter[character.character_id] = tags;
                    tags.forEach(tag => allTagsSet.add(tag));
                }
            });
            
            const pythonCode = `# Tags extraits depuis les captures d'√©cran MSF
# Format: character_id = ["tag1", "tag2", "tag3"]

character_tags = ${JSON.stringify(tagsByCharacter, null, 4).replace(/"/g, '"')}

# Tags disponibles
available_tags = ${JSON.stringify(Array.from(allTagsSet).sort(), null, 4).replace(/"/g, '"')}`;
            
            downloadFile('character_tags.py', pythonCode);
        }

        // Exporter en JSON
        function exportTagsJSON() {
            const exportData = {
                character_tags: {},
                available_tags: []
            };
            
            const allTagsSet = new Set();
            
            allCharacters.forEach(character => {
                if (character.tags !== 'AUCUN') {
                    const tags = character.tags.split(', ').map(tag => tag.trim());
                    exportData.character_tags[character.character_id] = tags;
                    tags.forEach(tag => allTagsSet.add(tag));
                }
            });
            
            exportData.available_tags = Array.from(allTagsSet).sort();
            
            downloadFile('character_tags.json', JSON.stringify(exportData, null, 2));
        }

        // T√©l√©charger un fichier
        function downloadFile(filename, content) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // Importer des tags
        function importTags() {
            const data = document.getElementById('importData').value.trim();
            
            try {
                // Essayer de parser en JSON d'abord
                const parsed = JSON.parse(data);
                
                if (parsed.character_tags) {
                    // Appliquer les tags import√©s
                    Object.keys(parsed.character_tags).forEach(characterId => {
                        const character = allCharacters.find(c => c.character_id === characterId);
                        if (character) {
                            character.tags = parsed.character_tags[characterId].join(', ');
                        }
                    });
                    
                    filterCharacters(); // Rafra√Æchir l'affichage
                    alert('Tags import√©s avec succ√®s!');
                }
            } catch (error) {
                alert('Erreur lors de l\'import: Format JSON invalide');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacters();
        });
    </script>
</body>
</html>